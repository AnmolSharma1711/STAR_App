name: Build Android APK

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install frontend dependencies
        working-directory: frontend/app
        run: |
          npm install
          npm install @capacitor/cli @capacitor/core @capacitor/android

      - name: Build frontend
        working-directory: frontend/app
        run: npm run build
        env:
          VITE_API_URL: https://tars-bkv7.onrender.com

      - name: Verify Capacitor config exists
        working-directory: frontend/app
        run: |
          if [ ! -f "capacitor.config.json" ]; then
            echo "Creating capacitor.config.json"
            cat > capacitor.config.json << 'EOF'
          {
            "appId": "com.tars.app",
            "appName": "TARS",
            "webDir": "dist",
            "server": {
              "androidScheme": "https"
            }
          }
          EOF
          else
            echo "capacitor.config.json already exists"
          fi
          cat capacitor.config.json

      - name: Remove TypeScript config if exists
        working-directory: frontend/app
        run: rm -f capacitor.config.ts

      - name: Setup Capacitor config
        working-directory: frontend/app
        run: |
          cat > capacitor.config.json << 'EOF'
          {
            "appId": "com.tars.app",
            "appName": "TARS",
            "webDir": "dist",
            "server": {
              "androidScheme": "https"
            }
          }
          EOF

      - name: Initialize Capacitor
        working-directory: frontend/app
        run: npx cap init "TARS" "com.tars.app" --web-dir=dist || true

      - name: Add Android platform
        working-directory: frontend/app
        run: npx cap add android

      - name: Ensure Android SDK is available
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          echo "y" | sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"

      # Skipping Java version patching; we install JDK 21 instead

      - name: Setup network security config
        working-directory: frontend/app
        run: |
          mkdir -p android/app/src/main/res/xml
          cat > android/app/src/main/res/xml/network_security_config.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <network-security-config>
              <domain-config cleartextTrafficPermitted="true">
                  <domain includeSubdomains="true">192.168.198.127</domain>
                  <domain includeSubdomains="true">10.0.2.2</domain>
                  <domain includeSubdomains="true">localhost</domain>
              </domain-config>
              <base-config cleartextTrafficPermitted="false" />
          </network-security-config>
          EOF

      - name: Update AndroidManifest
        working-directory: frontend/app
        run: |
          sed -i 's|<application|<application\n        android:networkSecurityConfig="@xml/network_security_config"\n        android:usesCleartextTraffic="true"|' android/app/src/main/AndroidManifest.xml
          sed -i 's|</manifest>|    <uses-permission android:name="android.permission.INTERNET" />\n    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />\n</manifest>|' android/app/src/main/AndroidManifest.xml

      - name: Sync Capacitor
        working-directory: frontend/app
        run: npx cap sync android

      - name: Build APK
        working-directory: frontend/app/android
        env:
          ORG_GRADLE_JAVA_HOME: ${{ env.JAVA_HOME_21_X64 }}
          JAVA_HOME: ${{ env.JAVA_HOME_21_X64 }}
        run: |
          echo "Using JAVA_HOME=$JAVA_HOME"
          chmod +x ./gradlew
          ./gradlew assembleDebug --stacktrace --info

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: tars-app-debug
          path: frontend/app/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30
